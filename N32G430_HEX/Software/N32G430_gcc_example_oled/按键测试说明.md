# 按键测试Demo使用说明

## 📋 功能概述

按键测试Demo用于验证TIM2+DMA硬件消抖功能，支持短按和长按检测，并通过UART1输出详细日志。

## ⚙️ 配置参数

### 按键检测参数
```c
DMA Buffer采样大小: 30个样本 (30ms @ 1kHz采样率)
短按阈值: 21/30 (0.7权重)
长按检测时长: 70ms
防抖间隔: 50ms
```

### 硬件连接
- **PB11** → 按键输入（低电平有效，内部已配置上拉）
- **PA9** → UART1 TX（115200 bps，8N1）
- **PA10** → UART1 RX

## 🎮 测试说明

### 1. LCD显示内容
```
╔═══════════════════════════════════╗
║      Button Test Demo             ║ ← 蓝色标题栏
╠═══════════════════════════════════╣
║ Button Test                       ║
║                                   ║
║ Short: 0                          ║ ← 短按次数
║ Long:  0                          ║ ← 长按次数
║ Release: 0                        ║ ← 释放次数
║                                   ║
║ PB11: Test button                 ║ ← 按键说明
║ Short: <70ms                      ║
║ Long:  >=70ms                     ║
╚═══════════════════════════════════╝
```

### 2. UART1日志输出示例

**启动信息：**
```
========================================
Button Test Demo Started
========================================
Configuration:
  - Sample size: 30 samples (30ms)
  - Threshold: 21/30 (0.7 weight)
  - Long press: 70ms
  - Debounce: 50ms
========================================
```

**短按事件：**
```
[1234 ms] SHORT PRESS detected (count: 1)
  - Duration since last event: 0 ms
  - DMA buffer threshold: 21/30 samples
```

**长按事件：**
```
[1304 ms] LONG PRESS detected (count: 1)
  - Press duration: >= 70ms
  - Total long presses: 1
```

**释放事件：**
```
[1404 ms] RELEASE detected (count: 1)
  - Duration since press: 100 ms
```

## 📊 测试要点

### 1. DMA Buffer消抖测试
- **目的**: 验证30ms采样窗口和0.7权重阈值
- **测试方法**:
  - 快速点击按键（抖动）
  - 观察UART日志中的"DMA buffer threshold"
  - 只有超过21/30采样为低电平才会触发按键事件

### 2. 短按检测 (<70ms)
- **LCD反馈**: 绿色闪烁
- **计数**: "Short"计数增加
- **UART日志**: 显示"SHORT PRESS detected"

### 3. 长按检测 (>=70ms)
- **LCD反馈**: 黄色闪烁
- **计数**: "Long"计数增加
- **UART日志**: 显示"LONG PRESS detected"
- **特点**: 按住超过70ms后触发，释放前只触发一次

### 4. 防抖验证
- **测试方法**: 快速连续按键
- **预期结果**: 两次有效事件间隔至少50ms
- **观察**: UART日志中的"Duration since last event"

## 🔧 调试技巧

### 修改检测参数
编辑 `core/inc/button.h`:
```c
#define BUTTON_SAMPLE_SIZE          30      // 采样窗口
#define BUTTON_PRESS_THRESHOLD      21      // 阈值
#define BUTTON_LONG_PRESS_SAMPLES   70      // 长按时长
#define BUTTON_DEBOUNCE_MS          50      // 防抖间隔
```

### 查看DMA Buffer原始数据
在 `button.c` 的 `Button_ProcessSamples()` 函数中添加调试代码：
```c
// 打印DMA buffer内容
for (uint8_t i = 0; i < BUTTON_SAMPLE_SIZE; i++) {
    printf("%d ", (button_ctx.sample_buffer[i] & (1 << 11)) ? 1 : 0);
}
printf("\nZero count: %d/%d\n", zero_count, BUTTON_SAMPLE_SIZE);
```

## 📈 性能指标

### 响应时间
- **短按检测**: 30ms (DMA buffer采样时间)
- **长按检测**: 70ms
- **总延迟**: 采样时间 + 防抖时间 (30ms + 50ms)

### CPU占用
- **DMA模式**: 几乎0% (硬件自动采样)
- **中断处理**: < 1% (仅DMA完成中断)

### 内存占用
- **DMA Buffer**: 30 bytes
- **上下文结构**: ~40 bytes
- **总计**: < 100 bytes

## 🎯 预期结果

正常工作时应看到：
1. ✅ LCD实时显示按键统计
2. ✅ UART1输出详细日志
3. ✅ 短按时绿色闪烁
4. ✅ 长按时黄色闪烁
5. ✅ 无误触发（抖动被过滤）
6. ✅ 响应灵敏（30ms延迟）

## 🐛 故障排查

### 问题1: 无按键响应
- 检查PB11接线
- 确认按键为低电平有效
- 查看UART是否有"Configuration"输出

### 问题2: 频繁误触发
- 降低阈值 (如改为18/30)
- 增加防抖时间 (如改为100ms)
- 检查硬件是否有干扰

### 问题3: 长按无法触发
- 按住时间需>=70ms
- 检查UART日志中的"Press duration"
- 确认未在70ms前释放

## 📝 编译信息

```
text: 52864 bytes (代码段)
data: 1768 bytes (初始化数据)
bss:  2784 bytes (未初始化数据)
总计: 57416 bytes (~56KB)
```

**输出文件**: `GCC/build/output.hex` 和 `output.bin`

---

**版本**: 1.0
**日期**: 2025-12-13
**平台**: N32G430 + ST7735S LCD (160x128 横屏)
